\hypertarget{client_8hpp_source}{}\doxysection{client.\+hpp}
\label{client_8hpp_source}\index{src/client.hpp@{src/client.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{preprocessor}{\#ifndef UTIL\_CLIENT\_HPP}}
\DoxyCodeLine{2 \textcolor{preprocessor}{\#define UTIL\_CLIENT\_HPP}}
\DoxyCodeLine{3 }
\DoxyCodeLine{4 \textcolor{preprocessor}{\#include <functional>}}
\DoxyCodeLine{5 \textcolor{preprocessor}{\#include <future>}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#include <iostream>}}
\DoxyCodeLine{7 \textcolor{preprocessor}{\#include <event.hpp>}}
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include <logger.hpp>}}
\DoxyCodeLine{9 }
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include <arpa/inet.h>}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <stdexcept>}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <sys/socket.h>}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <unistd.h>}}
\DoxyCodeLine{14 }
\DoxyCodeLine{15 \textcolor{keyword}{namespace }util \{}
\DoxyCodeLine{16 }
\DoxyCodeLine{21 \textcolor{keyword}{enum class} CLIENT\_EVENTS \{}
\DoxyCodeLine{22     \textcolor{comment}{// * logging events}}
\DoxyCodeLine{23     before\_log,}
\DoxyCodeLine{24     after\_log,}
\DoxyCodeLine{25 }
\DoxyCodeLine{26     \textcolor{comment}{// * connect events}}
\DoxyCodeLine{27     server\_connected,}
\DoxyCodeLine{28     server\_disconccected,}
\DoxyCodeLine{29 }
\DoxyCodeLine{30     \textcolor{comment}{// * send/recv events}}
\DoxyCodeLine{31     client\_send,}
\DoxyCodeLine{32     client\_receve,}
\DoxyCodeLine{33 }
\DoxyCodeLine{34     \textcolor{comment}{// * intialzieation/shutdown events}}
\DoxyCodeLine{35     client\_start\_listen,}
\DoxyCodeLine{36     client\_finished\_listen,}
\DoxyCodeLine{37 \};}
\DoxyCodeLine{38 }
\DoxyCodeLine{39 \textcolor{keyword}{class }\mbox{\hyperlink{classutil_1_1client__before__log__event}{client\_before\_log\_event}} : \textcolor{keyword}{public} \mbox{\hyperlink{classutil_1_1event}{util::event}}<CLIENT\_EVENTS> \{}
\DoxyCodeLine{40 \textcolor{keyword}{public}:}
\DoxyCodeLine{41 }
\DoxyCodeLine{42     EVENT\_CLASS\_TYPE(CLIENT\_EVENTS, before\_log);}
\DoxyCodeLine{43 }
\DoxyCodeLine{44 \};}
\DoxyCodeLine{45 }
\DoxyCodeLine{46 \textcolor{keyword}{class }\mbox{\hyperlink{classutil_1_1client__after__log__event}{client\_after\_log\_event}} : \textcolor{keyword}{public} \mbox{\hyperlink{classutil_1_1event}{util::event}}<CLIENT\_EVENTS> \{}
\DoxyCodeLine{47 \textcolor{keyword}{public}:}
\DoxyCodeLine{48 }
\DoxyCodeLine{49     EVENT\_CLASS\_TYPE(CLIENT\_EVENTS, after\_log);}
\DoxyCodeLine{50 }
\DoxyCodeLine{51 \};}
\DoxyCodeLine{52 }
\DoxyCodeLine{53 \textcolor{keyword}{class }\mbox{\hyperlink{classutil_1_1client__listen__event}{client\_listen\_event}} : \textcolor{keyword}{public} \mbox{\hyperlink{classutil_1_1event}{util::event}}<CLIENT\_EVENTS> \{}
\DoxyCodeLine{54 }
\DoxyCodeLine{55 \};}
\DoxyCodeLine{56 }
\DoxyCodeLine{57 \textcolor{keyword}{class }\mbox{\hyperlink{classutil_1_1client__finished__listen__event}{client\_finished\_listen\_event}} : \textcolor{keyword}{public} \mbox{\hyperlink{classutil_1_1client__listen__event}{client\_listen\_event}} \{}
\DoxyCodeLine{58 \textcolor{keyword}{public}:}
\DoxyCodeLine{59 }
\DoxyCodeLine{60     EVENT\_CLASS\_TYPE(CLIENT\_EVENTS, client\_finished\_listen);}
\DoxyCodeLine{61 }
\DoxyCodeLine{62 \};}
\DoxyCodeLine{63 }
\DoxyCodeLine{64 \textcolor{keyword}{class }\mbox{\hyperlink{classutil_1_1client__start__listen__event}{client\_start\_listen\_event}} : \textcolor{keyword}{public} \mbox{\hyperlink{classutil_1_1client__listen__event}{client\_listen\_event}} \{}
\DoxyCodeLine{65 \textcolor{keyword}{public}:}
\DoxyCodeLine{66 }
\DoxyCodeLine{67     EVENT\_CLASS\_TYPE(CLIENT\_EVENTS, client\_finished\_listen);}
\DoxyCodeLine{68 }
\DoxyCodeLine{69 \};}
\DoxyCodeLine{70 }
\DoxyCodeLine{71 \textcolor{keyword}{class }\mbox{\hyperlink{classutil_1_1client__connect__event}{client\_connect\_event}} : \textcolor{keyword}{public} \mbox{\hyperlink{classutil_1_1event}{util::event}}<CLIENT\_EVENTS> \{}
\DoxyCodeLine{72 \textcolor{keyword}{public}:}
\DoxyCodeLine{73 }
\DoxyCodeLine{74     \mbox{\hyperlink{classutil_1_1client__connect__event}{client\_connect\_event}}(\textcolor{keyword}{const} \textcolor{keywordtype}{int}\& t\_serverFd, \textcolor{keyword}{const} \textcolor{keywordtype}{int}\& t\_clientFd, \textcolor{keyword}{const} std::string\& t\_ip, \textcolor{keyword}{const} \textcolor{keywordtype}{int}\& t\_port) }
\DoxyCodeLine{75         : m\_serverFd(t\_serverFd), m\_clientFd(t\_clientFd), m\_ip(t\_ip), m\_port(t\_port) \{\}}
\DoxyCodeLine{76 }
\DoxyCodeLine{77     \textcolor{keywordtype}{int} getServerFd()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} m\_serverFd; \}}
\DoxyCodeLine{78     \textcolor{keywordtype}{int} getClientFd()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} m\_clientFd; \}}
\DoxyCodeLine{79     \textcolor{keywordtype}{int} getPort()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} m\_port; \}}
\DoxyCodeLine{80     std::string getIp()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} m\_ip; \}}
\DoxyCodeLine{81 }
\DoxyCodeLine{82     EVENT\_CLASS\_TYPE(CLIENT\_EVENTS, server\_connected);}
\DoxyCodeLine{83 }
\DoxyCodeLine{84 \textcolor{keyword}{private}:}
\DoxyCodeLine{85 }
\DoxyCodeLine{86     \textcolor{keywordtype}{int} m\_serverFd;}
\DoxyCodeLine{87     \textcolor{keywordtype}{int} m\_clientFd;}
\DoxyCodeLine{88     std::string m\_ip;}
\DoxyCodeLine{89     \textcolor{keywordtype}{int} m\_port;}
\DoxyCodeLine{90 }
\DoxyCodeLine{91 \};}
\DoxyCodeLine{92 }
\DoxyCodeLine{93 \textcolor{keyword}{class }\mbox{\hyperlink{classutil_1_1client__disconnect__event}{client\_disconnect\_event}} : \textcolor{keyword}{public} \mbox{\hyperlink{classutil_1_1event}{util::event}}<CLIENT\_EVENTS> \{}
\DoxyCodeLine{94 \textcolor{keyword}{public}:}
\DoxyCodeLine{95 }
\DoxyCodeLine{96     EVENT\_CLASS\_TYPE(CLIENT\_EVENTS, server\_disconccected);}
\DoxyCodeLine{97 }
\DoxyCodeLine{98 \};}
\DoxyCodeLine{99 }
\DoxyCodeLine{100 \textcolor{keyword}{class }\mbox{\hyperlink{classutil_1_1client__communication__event}{client\_communication\_event}} : \textcolor{keyword}{public} \mbox{\hyperlink{classutil_1_1event}{util::event}}<CLIENT\_EVENTS> \{}
\DoxyCodeLine{101 }
\DoxyCodeLine{102 \textcolor{keyword}{public}:}
\DoxyCodeLine{103     }
\DoxyCodeLine{104     \mbox{\hyperlink{classutil_1_1client__communication__event}{client\_communication\_event}}(\textcolor{keyword}{const} \textcolor{keywordtype}{int}\& t\_serverFd, \textcolor{keyword}{const} \textcolor{keywordtype}{char}* t\_data, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t}\& t\_dataSize) : m\_serverFd(t\_serverFd), m\_dataSize(t\_dataSize) \{}
\DoxyCodeLine{105         m\_data = \textcolor{keyword}{new} \textcolor{keywordtype}{char}[m\_dataSize];}
\DoxyCodeLine{106         memcpy(m\_data, t\_data, (\textcolor{keywordtype}{size\_t})m\_dataSize);}
\DoxyCodeLine{107     \}}
\DoxyCodeLine{108 }
\DoxyCodeLine{109     \mbox{\hyperlink{classutil_1_1client__communication__event}{\string~client\_communication\_event}}() \{}
\DoxyCodeLine{110         \textcolor{keyword}{delete}[] m\_data;}
\DoxyCodeLine{111     \}}
\DoxyCodeLine{112 }
\DoxyCodeLine{113     std::string getDataAsString()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} std::string(m\_data, m\_dataSize); \}}
\DoxyCodeLine{114     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* getData()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} m\_data; \}}
\DoxyCodeLine{115     \textcolor{keywordtype}{size\_t} getDataSize()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} m\_dataSize; \}}
\DoxyCodeLine{116 }
\DoxyCodeLine{117 \textcolor{keyword}{private}:}
\DoxyCodeLine{118 }
\DoxyCodeLine{119     \textcolor{keywordtype}{int} m\_serverFd;}
\DoxyCodeLine{120     \textcolor{keywordtype}{char}* m\_data;}
\DoxyCodeLine{121     \textcolor{keywordtype}{size\_t} m\_dataSize;}
\DoxyCodeLine{122 \};}
\DoxyCodeLine{123 }
\DoxyCodeLine{124 }
\DoxyCodeLine{125 \textcolor{keyword}{class }\mbox{\hyperlink{classutil_1_1client__send__event}{client\_send\_event}} : \textcolor{keyword}{public} \mbox{\hyperlink{classutil_1_1client__communication__event}{client\_communication\_event}} \{}
\DoxyCodeLine{126 \textcolor{keyword}{public}:}
\DoxyCodeLine{127 }
\DoxyCodeLine{128     \mbox{\hyperlink{classutil_1_1client__send__event}{client\_send\_event}}(\textcolor{keyword}{const} \textcolor{keywordtype}{int}\& t\_serverFd, \textcolor{keyword}{const} \textcolor{keywordtype}{char}* t\_data, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t}\& t\_dataSize) : \mbox{\hyperlink{classutil_1_1client__communication__event}{client\_communication\_event}}(t\_serverFd, t\_data, t\_dataSize) \{\}}
\DoxyCodeLine{129 }
\DoxyCodeLine{130     EVENT\_CLASS\_TYPE(CLIENT\_EVENTS, client\_send);}
\DoxyCodeLine{131 }
\DoxyCodeLine{132 \textcolor{keyword}{private}:}
\DoxyCodeLine{133 }
\DoxyCodeLine{134 }
\DoxyCodeLine{135 \};}
\DoxyCodeLine{136 }
\DoxyCodeLine{137 \textcolor{keyword}{class }\mbox{\hyperlink{classutil_1_1client__receve__event}{client\_receve\_event}} : \textcolor{keyword}{public} \mbox{\hyperlink{classutil_1_1client__communication__event}{client\_communication\_event}} \{}
\DoxyCodeLine{138 \textcolor{keyword}{public}:}
\DoxyCodeLine{139 }
\DoxyCodeLine{140     \mbox{\hyperlink{classutil_1_1client__receve__event}{client\_receve\_event}}(\textcolor{keyword}{const} \textcolor{keywordtype}{int}\& t\_serverFd, \textcolor{keyword}{const} \textcolor{keywordtype}{char}* t\_data, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t}\& t\_dataSize) : \mbox{\hyperlink{classutil_1_1client__communication__event}{client\_communication\_event}}(t\_serverFd, t\_data, t\_dataSize) \{\}}
\DoxyCodeLine{141 }
\DoxyCodeLine{142     EVENT\_CLASS\_TYPE(CLIENT\_EVENTS, client\_receve);}
\DoxyCodeLine{143 }
\DoxyCodeLine{144 \};}
\DoxyCodeLine{145 }
\DoxyCodeLine{146 \textcolor{keyword}{class }\mbox{\hyperlink{classutil_1_1client}{client}} \{}
\DoxyCodeLine{147 }
\DoxyCodeLine{148     \textcolor{keyword}{using }eventFn = std::function<void(\mbox{\hyperlink{classutil_1_1event}{util::event<CLIENT\_EVENTS>}}\&)>;}
\DoxyCodeLine{149 }
\DoxyCodeLine{150 \textcolor{keyword}{public}:}
\DoxyCodeLine{151 }
\DoxyCodeLine{152     \mbox{\hyperlink{classutil_1_1client}{client}}(\textcolor{keyword}{const} std::string\& t\_ip, \textcolor{keyword}{const} \textcolor{keywordtype}{int}\& t\_port, eventFn t\_eventFn, \mbox{\hyperlink{classutil_1_1logger}{util::logger}}\& t\_logger) : m\_ip(t\_ip), m\_port(t\_port), m\_logger(t\_logger), m\_eventFunction(t\_eventFn) \{}
\DoxyCodeLine{153         m\_alive = \textcolor{keyword}{false};}
\DoxyCodeLine{154         m\_closed = \textcolor{keyword}{true};}
\DoxyCodeLine{155         connectServer();}
\DoxyCodeLine{156         startListenThread();}
\DoxyCodeLine{157     \}}
\DoxyCodeLine{158 }
\DoxyCodeLine{159     \textcolor{keywordtype}{void} disconnect() \{}
\DoxyCodeLine{160         handleDisconnect();}
\DoxyCodeLine{161     \}}
\DoxyCodeLine{162 }
\DoxyCodeLine{163     \textcolor{keywordtype}{void} reconnect() \{}
\DoxyCodeLine{164         connectServer();}
\DoxyCodeLine{165         startListenThread();}
\DoxyCodeLine{166     \}}
\DoxyCodeLine{167 }
\DoxyCodeLine{168     \textcolor{keywordtype}{void} sendServer(\textcolor{keyword}{const} std::string\& t\_message) \{}
\DoxyCodeLine{169         handleSend(t\_message.c\_str(), strlen(t\_message.c\_str()));}
\DoxyCodeLine{170     \}}
\DoxyCodeLine{171 }
\DoxyCodeLine{172     \textcolor{keywordtype}{void} sendServer(\textcolor{keywordtype}{char}* t\_buff, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t}\& t\_buffSize) \{}
\DoxyCodeLine{173         handleSend(t\_buff, t\_buffSize);}
\DoxyCodeLine{174     \}}
\DoxyCodeLine{175 }
\DoxyCodeLine{176     \mbox{\hyperlink{classutil_1_1client}{\string~client}}() \{}
\DoxyCodeLine{177         handleDisconnect();}
\DoxyCodeLine{178     \}}
\DoxyCodeLine{179 }
\DoxyCodeLine{180     \textcolor{keywordtype}{bool} alive()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} m\_alive; \}}
\DoxyCodeLine{181 }
\DoxyCodeLine{182 \textcolor{keyword}{private}:}
\DoxyCodeLine{183 }
\DoxyCodeLine{184     \textcolor{keywordtype}{void} startListenThread() \{}
\DoxyCodeLine{185         \textcolor{comment}{// * only restart the listen thread if it is not started allready }}
\DoxyCodeLine{186         \textcolor{keyword}{using namespace }std::chrono\_literals;}
\DoxyCodeLine{187         \textcolor{keywordflow}{if} (m\_clientThread.wait\_for(0ms) != std::future\_status::ready) \{}
\DoxyCodeLine{188             \textcolor{comment}{// * set active to true as server is initalized and launch the listen thread}}
\DoxyCodeLine{189             logMessage(util::LOGGER\_LEVEL::INFO, \textcolor{stringliteral}{"{}starting client listen thread..."{}});}
\DoxyCodeLine{190             m\_alive = \textcolor{keyword}{true};}
\DoxyCodeLine{191             m\_clientThread = std::async(std::launch::async, \&client::clientListen, \textcolor{keyword}{this});}
\DoxyCodeLine{192 }
\DoxyCodeLine{193             \textcolor{comment}{// * dispatch the listen event}}
\DoxyCodeLine{194             \mbox{\hyperlink{classutil_1_1client__start__listen__event}{client\_start\_listen\_event}} listenStartEv;}
\DoxyCodeLine{195             m\_eventFunction(listenStartEv);}
\DoxyCodeLine{196         \}}
\DoxyCodeLine{197     \}}
\DoxyCodeLine{198 }
\DoxyCodeLine{199     \textcolor{keywordtype}{void} connectServer() \{}
\DoxyCodeLine{200         \textcolor{comment}{// * only connect if the server socket has been closed}}
\DoxyCodeLine{201         \textcolor{keywordflow}{if} (m\_closed == \textcolor{keyword}{true}) \{}
\DoxyCodeLine{202             \textcolor{comment}{// * create server socket and check for error}}
\DoxyCodeLine{203             \textcolor{keywordflow}{if} ((m\_serverFd = socket(AF\_INET, SOCK\_STREAM, 0)) < 0) \{}
\DoxyCodeLine{204                 logMessage(util::LOGGER\_LEVEL::CRITICAL, \textcolor{stringliteral}{"{}failed to create server socket"{}});}
\DoxyCodeLine{205                 logMessage(util::LOGGER\_LEVEL::ERROR, \mbox{\hyperlink{algo_8hpp_ab244f610a04eae09fbacef0e4e9bdc80}{util::fmt}}(\textcolor{stringliteral}{"{}socket error: \{\}"{}}, strerror(errno)));}
\DoxyCodeLine{206                 \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"{}failed to create server socket"{}});}
\DoxyCodeLine{207             \}}
\DoxyCodeLine{208             m\_closed = \textcolor{keyword}{false};}
\DoxyCodeLine{209 }
\DoxyCodeLine{210             \textcolor{comment}{// * define server port and address}}
\DoxyCodeLine{211             sockaddr\_in serveraddr;}
\DoxyCodeLine{212             serveraddr.sin\_port = htons(m\_port);}
\DoxyCodeLine{213             serveraddr.sin\_family = AF\_INET;}
\DoxyCodeLine{214 }
\DoxyCodeLine{215             \textcolor{comment}{// * conver IPv4 to IPv6 and set in sockaddr\_in struct and check for error}}
\DoxyCodeLine{216             \textcolor{keywordflow}{if} (inet\_pton(AF\_INET, m\_ip.c\_str(), \&serveraddr.sin\_addr) <= 0) \{}
\DoxyCodeLine{217                 logMessage(util::LOGGER\_LEVEL::CRITICAL, \textcolor{stringliteral}{"{}server IP address not valid"{}});}
\DoxyCodeLine{218                 logMessage(util::LOGGER\_LEVEL::ERROR, \mbox{\hyperlink{algo_8hpp_ab244f610a04eae09fbacef0e4e9bdc80}{util::fmt}}(\textcolor{stringliteral}{"{}inet\_pron error: \{\}"{}}, strerror(errno)));}
\DoxyCodeLine{219                 \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"{}server IP address not valid"{}});}
\DoxyCodeLine{220             \}}
\DoxyCodeLine{221 }
\DoxyCodeLine{222             \textcolor{comment}{// * log that the clinet is about to connect to server}}
\DoxyCodeLine{223             logMessage(util::LOGGER\_LEVEL::INFO, \mbox{\hyperlink{algo_8hpp_ab244f610a04eae09fbacef0e4e9bdc80}{util::fmt}}(\textcolor{stringliteral}{"{}connecting to server at ip \{\} on port \{\}"{}}, m\_ip, m\_port));}
\DoxyCodeLine{224 }
\DoxyCodeLine{225             \textcolor{comment}{// * connect to server}}
\DoxyCodeLine{226             \textcolor{keywordflow}{if} ((m\_clientFd = connect(m\_serverFd, (sockaddr*)\&serveraddr, \textcolor{keyword}{sizeof}(serveraddr))) < 0) \{}
\DoxyCodeLine{227                 logMessage(util::LOGGER\_LEVEL::CRITICAL, \textcolor{stringliteral}{"{}failed to connect to server"{}});}
\DoxyCodeLine{228                 logMessage(util::LOGGER\_LEVEL::ERROR, \mbox{\hyperlink{algo_8hpp_ab244f610a04eae09fbacef0e4e9bdc80}{util::fmt}}(\textcolor{stringliteral}{"{}connect error: \{\}"{}}, strerror(errno)));}
\DoxyCodeLine{229                 \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"{}failed to connect to server"{}});}
\DoxyCodeLine{230             \}}
\DoxyCodeLine{231 }
\DoxyCodeLine{232             \textcolor{comment}{// * server connected evnet and dispatch}}
\DoxyCodeLine{233             \mbox{\hyperlink{classutil_1_1client__connect__event}{client\_connect\_event}} connEv(m\_serverFd, m\_clientFd, m\_ip, m\_port);}
\DoxyCodeLine{234             m\_eventFunction(connEv);}
\DoxyCodeLine{235 }
\DoxyCodeLine{236             \textcolor{comment}{// * log client is connected}}
\DoxyCodeLine{237             logMessage(util::LOGGER\_LEVEL::INFO, \mbox{\hyperlink{algo_8hpp_ab244f610a04eae09fbacef0e4e9bdc80}{util::fmt}}(\textcolor{stringliteral}{"{}connected to server at ip \{\} on port \{\}"{}}, m\_ip, m\_port));}
\DoxyCodeLine{238         \}}
\DoxyCodeLine{239     \}}
\DoxyCodeLine{240 }
\DoxyCodeLine{241     \textcolor{keywordtype}{void} handleSend(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* t\_data, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t}\& t\_dataSize) \{}
\DoxyCodeLine{242         \textcolor{comment}{// * get message in human readable format to log}}
\DoxyCodeLine{243         std::string message(t\_data, t\_dataSize);}
\DoxyCodeLine{244         \textcolor{comment}{// * remove newline to not mess up terminal output}}
\DoxyCodeLine{245         message.erase(std::remove(message.begin(), message.end(), \textcolor{charliteral}{'\(\backslash\)n'}), message.cend());}
\DoxyCodeLine{246 }
\DoxyCodeLine{247         \textcolor{comment}{// * log the message was sent}}
\DoxyCodeLine{248         logMessage(util::LOGGER\_LEVEL::INFO, \mbox{\hyperlink{algo_8hpp_ab244f610a04eae09fbacef0e4e9bdc80}{util::fmt}}(\textcolor{stringliteral}{"{}sending server (ip \{\}, port \{\}) data: \{\}"{}}, m\_ip, m\_port, message));}
\DoxyCodeLine{249 }
\DoxyCodeLine{250         \textcolor{comment}{// * create send message event and dispatch to event function}}
\DoxyCodeLine{251         \mbox{\hyperlink{classutil_1_1client__send__event}{client\_send\_event}} sendEv = \mbox{\hyperlink{classutil_1_1client__send__event}{client\_send\_event}}(m\_serverFd, t\_data, t\_dataSize);}
\DoxyCodeLine{252         m\_eventFunction(sendEv);}
\DoxyCodeLine{253 }
\DoxyCodeLine{254         \textcolor{comment}{// * send the bytes to the client}}
\DoxyCodeLine{255         send(m\_serverFd, (\textcolor{keywordtype}{void}*)t\_data, t\_dataSize, 0);}
\DoxyCodeLine{256     \}}
\DoxyCodeLine{257 }
\DoxyCodeLine{258 }
\DoxyCodeLine{259     \textcolor{keywordtype}{void} clientListen() \{}
\DoxyCodeLine{260         \mbox{\hyperlink{classutil_1_1client__start__listen__event}{client\_start\_listen\_event}} startListenEv;}
\DoxyCodeLine{261         m\_eventFunction(startListenEv);}
\DoxyCodeLine{262         logMessage(util::LOGGER\_LEVEL::INFO, \textcolor{stringliteral}{"{}client listining for activity"{}});}
\DoxyCodeLine{263 }
\DoxyCodeLine{264         \textcolor{comment}{// * setup file discriptor set and timeout}}
\DoxyCodeLine{265         fd\_set readfds;}
\DoxyCodeLine{266         timeval tv;}
\DoxyCodeLine{267         tv.tv\_sec = 3;}
\DoxyCodeLine{268         tv.tv\_usec = 50;}
\DoxyCodeLine{269 }
\DoxyCodeLine{270         \textcolor{keywordflow}{while} (m\_alive) \{}
\DoxyCodeLine{271             \textcolor{comment}{// * clear the file discriptor set}}
\DoxyCodeLine{272             FD\_ZERO(\&readfds);}
\DoxyCodeLine{273             \textcolor{comment}{// * add the server socket to the file discriptor set}}
\DoxyCodeLine{274             FD\_SET(m\_serverFd, \&readfds);}
\DoxyCodeLine{275 }
\DoxyCodeLine{276             \textcolor{comment}{// * get the activity of the set}}
\DoxyCodeLine{277             \textcolor{keywordtype}{int} activity = select(m\_serverFd + 1, \&readfds, NULL, NULL, \&tv);}
\DoxyCodeLine{278 }
\DoxyCodeLine{279             \textcolor{comment}{// * negative activity means error, deal with accordingly}}
\DoxyCodeLine{280             \textcolor{keywordflow}{if} (activity < 0) \{}
\DoxyCodeLine{281 }
\DoxyCodeLine{282             \}}
\DoxyCodeLine{283 }
\DoxyCodeLine{284             \textcolor{comment}{// * zero activity means timeout (or no activity)}}
\DoxyCodeLine{285             \textcolor{keywordflow}{if} (activity == 0) \{}
\DoxyCodeLine{286                 \textcolor{keywordflow}{continue};}
\DoxyCodeLine{287             \}}
\DoxyCodeLine{288 }
\DoxyCodeLine{289             \textcolor{comment}{// * check for activity of the socket}}
\DoxyCodeLine{290             \textcolor{keywordflow}{if} (FD\_ISSET(m\_serverFd, \&readfds)) \{}
\DoxyCodeLine{291                 \textcolor{keywordflow}{if} (handleServerActivity()) \{}
\DoxyCodeLine{292                     m\_alive = \textcolor{keyword}{false};}
\DoxyCodeLine{293                     \textcolor{keywordflow}{continue};}
\DoxyCodeLine{294                 \}}
\DoxyCodeLine{295             \}}
\DoxyCodeLine{296         \}}
\DoxyCodeLine{297 }
\DoxyCodeLine{298         \mbox{\hyperlink{classutil_1_1client__finished__listen__event}{client\_finished\_listen\_event}} finishedListenEv;}
\DoxyCodeLine{299         m\_eventFunction(finishedListenEv);}
\DoxyCodeLine{300         logMessage(util::LOGGER\_LEVEL::INFO, \textcolor{stringliteral}{"{}client stopped listinig for activity"{}});}
\DoxyCodeLine{301     \}}
\DoxyCodeLine{302 }
\DoxyCodeLine{303     \textcolor{keywordtype}{bool} handleServerActivity() \{}
\DoxyCodeLine{304         \textcolor{keyword}{constexpr} \textcolor{keywordtype}{int} bufSize = 1024;}
\DoxyCodeLine{305         \textcolor{keywordtype}{char} buf[bufSize];}
\DoxyCodeLine{306         \textcolor{keywordtype}{size\_t} size;}
\DoxyCodeLine{307 }
\DoxyCodeLine{308         \textcolor{keywordflow}{if} ((size = read(m\_serverFd, buf, bufSize)) == 0) \{}
\DoxyCodeLine{309             \textcolor{comment}{// * server disconnected}}
\DoxyCodeLine{310             logMessage(util::LOGGER\_LEVEL::INFO, \textcolor{stringliteral}{"{}connection closed by forigin host"{}});}
\DoxyCodeLine{311             \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{312         \}}
\DoxyCodeLine{313 }
\DoxyCodeLine{314         handleRead(buf, size);}
\DoxyCodeLine{315         \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{316     \}}
\DoxyCodeLine{317 }
\DoxyCodeLine{318     \textcolor{keywordtype}{void} handleRead(\textcolor{keywordtype}{char} *t\_buf, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t}\& t\_size) \{}
\DoxyCodeLine{319         \textcolor{comment}{// * conver the buffer to a string}}
\DoxyCodeLine{320         std::string message(t\_buf, t\_size);}
\DoxyCodeLine{321         \textcolor{comment}{// * remove newline to not mess up terminal output}}
\DoxyCodeLine{322         message.erase(std::remove(message.begin(), message.end(), \textcolor{charliteral}{'\(\backslash\)n'}), message.cend());}
\DoxyCodeLine{323 }
\DoxyCodeLine{324         \textcolor{comment}{// * log read}}
\DoxyCodeLine{325         logMessage(util::LOGGER\_LEVEL::INFO, \mbox{\hyperlink{algo_8hpp_ab244f610a04eae09fbacef0e4e9bdc80}{util::fmt}}(\textcolor{stringliteral}{"{}server (ip \{\}, port \{\}) sent: \{\}"{}}, m\_ip, m\_port, message));}
\DoxyCodeLine{326 }
\DoxyCodeLine{327         \textcolor{comment}{// * create and dispatch read event}}
\DoxyCodeLine{328         \mbox{\hyperlink{classutil_1_1client__receve__event}{client\_receve\_event}} readEv(m\_serverFd, t\_buf, t\_size); }
\DoxyCodeLine{329         m\_eventFunction(readEv);}
\DoxyCodeLine{330     \}}
\DoxyCodeLine{331 }
\DoxyCodeLine{332 }
\DoxyCodeLine{333     \textcolor{keywordtype}{void} logMessage(\textcolor{keyword}{const} util::LOGGER\_LEVEL\& t\_level, \textcolor{keyword}{const} std::string\& t\_message)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{334         \textcolor{comment}{// * creater the before log event and send it to the event function}}
\DoxyCodeLine{335         \mbox{\hyperlink{classutil_1_1client__before__log__event}{client\_before\_log\_event}} beforeLog;}
\DoxyCodeLine{336         m\_eventFunction(beforeLog);}
\DoxyCodeLine{337 }
\DoxyCodeLine{338         \textcolor{comment}{// * log the message to ALL sinks}}
\DoxyCodeLine{339         m\_logger.\mbox{\hyperlink{classutil_1_1logger_a33f5598c0bdda53f2736eeec95eaeff0}{log}}(t\_message, t\_level);}
\DoxyCodeLine{340 }
\DoxyCodeLine{341         \textcolor{comment}{// * create the after log event and send it to the event function}}
\DoxyCodeLine{342         \mbox{\hyperlink{classutil_1_1client__after__log__event}{client\_after\_log\_event}} afterLog;}
\DoxyCodeLine{343         m\_eventFunction(afterLog);}
\DoxyCodeLine{344     \}}
\DoxyCodeLine{345 }
\DoxyCodeLine{346     \textcolor{keywordtype}{void} handleDisconnect() \{}
\DoxyCodeLine{347         \textcolor{keyword}{using namespace }std::chrono\_literals;}
\DoxyCodeLine{348         \textcolor{keywordflow}{if} (m\_clientThread.wait\_for(0ms) != std::future\_status::ready) \{}
\DoxyCodeLine{349             logMessage(util::LOGGER\_LEVEL::INFO, \textcolor{stringliteral}{"{}stopping client listen thread..."{}});}
\DoxyCodeLine{350             \textcolor{comment}{// * set active to false and wait for listen thread to join back}}
\DoxyCodeLine{351             m\_alive = \textcolor{keyword}{false};}
\DoxyCodeLine{352             m\_clientThread.wait();}
\DoxyCodeLine{353         \}}
\DoxyCodeLine{354 }
\DoxyCodeLine{355         \textcolor{keywordflow}{if} (!m\_closed) \{}
\DoxyCodeLine{356             \textcolor{comment}{// * log client disconnect}}
\DoxyCodeLine{357             logMessage(util::LOGGER\_LEVEL::INFO, \mbox{\hyperlink{algo_8hpp_ab244f610a04eae09fbacef0e4e9bdc80}{util::fmt}}(\textcolor{stringliteral}{"{}client disconnecting from server at ip \{\} on port \{\}"{}}, m\_ip, m\_port));}
\DoxyCodeLine{358 }
\DoxyCodeLine{359             \textcolor{comment}{// * close the client server connection}}
\DoxyCodeLine{360             close(m\_serverFd);}
\DoxyCodeLine{361             m\_closed = \textcolor{keyword}{true};}
\DoxyCodeLine{362 }
\DoxyCodeLine{363             \textcolor{comment}{// * client shutdown and dispach event}}
\DoxyCodeLine{364             \mbox{\hyperlink{classutil_1_1client__disconnect__event}{client\_disconnect\_event}} disconEv;}
\DoxyCodeLine{365             m\_eventFunction(disconEv);}
\DoxyCodeLine{366 }
\DoxyCodeLine{367             logMessage(util::LOGGER\_LEVEL::INFO, \textcolor{stringliteral}{"{}client shutdown"{}});}
\DoxyCodeLine{368         \}}
\DoxyCodeLine{369     \}}
\DoxyCodeLine{370 }
\DoxyCodeLine{371     \textcolor{keywordtype}{int} m\_serverFd, m\_clientFd;}
\DoxyCodeLine{372     \textcolor{keywordtype}{int} m\_port;}
\DoxyCodeLine{373     std::string m\_ip;}
\DoxyCodeLine{374     \mbox{\hyperlink{classutil_1_1logger}{util::logger}}\& m\_logger;}
\DoxyCodeLine{375     eventFn m\_eventFunction;}
\DoxyCodeLine{376     \textcolor{keywordtype}{bool} m\_alive;}
\DoxyCodeLine{377     std::future<void> m\_clientThread;}
\DoxyCodeLine{378     std::future<void> m\_shutdownThread;}
\DoxyCodeLine{379     \textcolor{keywordtype}{bool} m\_closed;}
\DoxyCodeLine{380 \};}
\DoxyCodeLine{381 }
\DoxyCodeLine{382 \}}
\DoxyCodeLine{383 }
\DoxyCodeLine{384 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
